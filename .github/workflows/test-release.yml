name: Test Release Binaries

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to test (for example: v0.1.0)"
        required: true
        type: string

permissions:
  contents: read

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-24.04
            archive: sona-linux-amd64-with-ffmpeg.tar.gz
            binary: sona
          - runner: ubuntu-24.04-arm
            archive: sona-linux-arm64-with-ffmpeg.tar.gz
            binary: sona
          - runner: macos-14
            archive: sona-darwin-arm64-with-ffmpeg.tar.gz
            binary: sona
          - runner: macos-15-intel
            archive: sona-darwin-amd64-with-ffmpeg.tar.gz
            binary: sona
          - runner: windows-latest
            archive: sona-windows-amd64-with-ffmpeg.zip
            binary: sona.exe
    runs-on: ${{ matrix.runner }}
    env:
      TAG: ${{ github.event.inputs.tag }}
      ARCHIVE: ${{ matrix.archive }}
      BINARY: ${{ matrix.binary }}
      MODEL_URL: https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-tiny.bin
      SAMPLE_URL: https://github.com/ggml-org/whisper.cpp/raw/master/samples/jfk.wav
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSYS2 wget (Windows)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          install: wget

      - name: Download release bundle and test assets (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mkdir -p models samples
          wget -O "${ARCHIVE}" "https://github.com/${{ github.repository }}/releases/download/${TAG}/${ARCHIVE}"
          tar -xzf "${ARCHIVE}"
          wget -O models/ggml-tiny.bin "${MODEL_URL}"
          wget -O samples/jfk.wav "${SAMPLE_URL}"
          chmod +x "${BINARY}"
          chmod +x ffmpeg || true

      - name: Run binary (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          "./${BINARY}" transcribe models/ggml-tiny.bin samples/jfk.wav

      - name: Download release bundle and test assets (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path models | Out-Null
          New-Item -ItemType Directory -Force -Path samples | Out-Null
          C:\msys64\usr\bin\wget.exe --progress=bar:force:noscroll "https://github.com/${{ github.repository }}/releases/download/$env:TAG/$env:ARCHIVE" -O "$env:ARCHIVE"
          Expand-Archive -Path "$env:ARCHIVE" -DestinationPath "." -Force
          C:\msys64\usr\bin\wget.exe --progress=bar:force:noscroll "$env:MODEL_URL" -O "models/ggml-tiny.bin"
          C:\msys64\usr\bin\wget.exe --progress=bar:force:noscroll "$env:SAMPLE_URL" -O "samples/jfk.wav"

      - name: Run binary (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          .\${{ matrix.binary }} transcribe models\ggml-tiny.bin samples\jfk.wav
